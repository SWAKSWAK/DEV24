<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dev24.client.book.dao.BookDAO">

	<resultMap type="book" id="bookResult">
		<result property="b_list" column="b_list" jdbcType="CLOB" javaType="java.lang.String"/>
		<result property="b_authorinfo" column="b_authorinfo" jdbcType="CLOB" javaType="java.lang.String"/>
		<result property="b_info" column="b_info" jdbcType="CLOB" javaType="java.lang.String"/>
	</resultMap>

	<!-- 시퀀스값 구하기 -->
	<select id="bookNumber" resultType="int">
		SELECT
			b_num_seq.nextval as b_num
		FROM
			dual
	</select>
	
	<!-- 도서 등록 -->
	<insert id="bookInsert" parameterType="book">
		INSERT INTO 
			book
		(
			b_num, b_name, b_date, b_list, b_author, 
			b_pub, b_authorinfo, b_info, b_price,
			catetwo_num, cateone_num
		) VALUES (
			#{b_num}, #{b_name}, #{b_date}, #{b_list,jdbcType=CLOB}, 
			#{b_author}, #{b_pub}, #{b_authorinfo,jdbcType=CLOB}, 
			#{b_info,jdbcType=CLOB}, #{b_price}, 
			#{cateOne_num}, #{cateTwo_num}
		)
	</insert>
	
	<!-- 도서 총 개수 출력, 카테고리 조건에 따라 총개수가 아닐 수 있음 -->
	<select id="getBookListCnt" resultType="int">
		SELECT
			count(*) as bookLength
		FROM
			book_view
		<where>
			<if test="cateOne_num == 0">
			</if>
			<if test="cateOne_num == 1">
				<![CDATA[AND cateOne_num = 1]]>
			</if>
			<if test="cateOne_num == 2">
				<![CDATA[AND cateOne_num = 2]]>
			</if>
			<if test="cateTwo_num == 0">
			</if>
			<if test="cateTwo_num == 1">
				<![CDATA[AND cateTwo_num = 1]]>
			</if>
			<if test="cateTwo_num == 2">
				<![CDATA[AND cateTwo_num = 2]]>
			</if>
			<if test="cateTwo_num == 3">
				<![CDATA[AND cateTwo_num = 3]]>
			</if>
			<if test="cateTwo_num == 4">
				<![CDATA[AND cateTwo_num = 4]]>
			</if>
			<if test="cateTwo_num == 5">
				<![CDATA[AND cateTwo_num = 5]]>
			</if>
		</where>
	</select>
	
	<!-- 도서리스트 출력, 카테고리 조건에 따라 출력내용이 다를 수 있음  -->
	<select id="bookViewList" parameterType="pagination" resultType="book">
		
			SELECT 
				rn, b_num, b_name, b_date, b_author,
				b_pub, b_price, b_state,
				cateOne_num, cateTwo_num, 
				ra_sum, ra_count,
				listcover_imgurl, detailcover_imgurl, detail_imgurl
			FROM (
			    SELECT 
			    	rownum rn, b_num, b_name, to_char(b_date, 'yyyy"년" MM"월" dd"일"') b_date, b_author,
					b_pub, b_price, b_state,
					cateOne_num, cateTwo_num,
					ra_sum, ra_count,
					listcover_imgurl, detailcover_imgurl, detail_imgurl
			    FROM
			    	book_view
				<where>
			        <![CDATA[
			        b_num > 0
			        AND
			        rownum <= #{lastRownum}
			        ]]>
					<if test="cateOne_num == 0">
					</if>
					<if test="cateOne_num == 1">
						<![CDATA[AND cateOne_num = 1]]>
					</if>
					<if test="cateOne_num == 2">
						<![CDATA[AND cateOne_num = 2]]>
					</if>
					<if test="cateTwo_num == 0">
					</if>
					<if test="cateTwo_num == 1">
						<![CDATA[AND cateTwo_num = 1]]>
					</if>
					<if test="cateTwo_num == 2">
						<![CDATA[AND cateTwo_num = 2]]>
					</if>
					<if test="cateTwo_num == 3">
						<![CDATA[AND cateTwo_num = 3]]>
					</if>
					<if test="cateTwo_num == 4">
						<![CDATA[AND cateTwo_num = 4]]>
					</if>
					<if test="cateTwo_num == 5">
						<![CDATA[AND cateTwo_num = 5]]>
					</if>
				</where>
			    )
			<![CDATA[WHERE rn > #{startRownum}]]>
	</select>
	
		<!-- 도서리스트 출력, 카테고리 조건에 따라 출력내용이 다를 수 있음  -->
	<select id="bookDetail" parameterType="int" resultType="book">
		
			SELECT 
				b_num, b_name, to_char(b_date, 'yyyy"년" MM"월" dd"일"') b_date, b_list, b_author,
				b_pub, b_authorinfo, b_info, b_price, b_state, 
				cateOne_num, cateTwo_num, 
				ra_sum, ra_count,
				detailcover_imgurl, detail_imgurl
			FROM 
				book_view
			WHERE
				b_num = #{b_num}
	</select>
	
</mapper>